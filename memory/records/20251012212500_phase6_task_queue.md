# Phase 6 — API Lifecycle & Hardening Task Queue

## Context
- Simulation/evaluation inject flows operate end-to-end (see `workspaces/Describing_Simulation_0/src/routes/simulation.ts` and `src/routes/evaluation.ts`), but eject endpoints still demand live `System` instances, making them unusable over HTTP.
- Server-Sent Events streams lack keep-alive messages, risking intermediary timeouts during long simulations.
- Authentication and rate limiting are not present, leaving the API exposed if published beyond local tooling.

## Task 1: Introduce ID-Based System Lifecycle
- **Lifecycle**: Phase 6 Stabilization — Step 1 (API Contract Fix)
- **Mindset**: Implementer
- **Workspace**: `workspaces/Describing_Simulation_0/src/core/Player.ts`, `src/core/simplayer/SimulationPlayer.ts`, `src/core/evalplayer/EvaluationPlayer.ts`, `src/routes/simulation.ts`, `src/routes/evaluation.ts`, related tests.
- **Guardrails**:
  - `instruction_documents/Describing_Simulation_0_codifying_simulations.md` — System lifecycle expectations.
  - Current integration specs in `tools/run_integration.js` for injection/ejection workflows.
- **Objective**: Issue unique identifiers when systems are injected and accept those IDs on eject calls so HTTP clients can manage system lifecycles.
- **Definition of Done**:
  1. Modify players to assign IDs on `injectSystem`, return the ID in HTTP responses, and track system-to-ID mappings internally.
  2. Update `/api/simulation/eject` and `/api/evaluation/system/eject` to accept `{ systemId }` payloads and remove matching systems.
  3. Extend unit/integration tests to cover inject/eject round-trips via HTTP, ensuring legacy call sites (if any) fail loudly.

## Task 2: Add SSE Heartbeats & Client Resilience
- **Lifecycle**: Phase 6 Stabilization — Step 2 (Streaming Reliability)
- **Mindset**: Implementer
- **Workspace**: `workspaces/Describing_Simulation_0/src/routes/simulation.ts`, `src/routes/evaluation.ts`, SSE-consuming tests/integration harness.
- **Guardrails**:
  - MDN SSE best practices (comment heartbeats) and existing integration workflow in `tools/run_integration.js`.
  - Ensure fast-cycle benchmarking remains accurate with added traffic.
- **Objective**: Emit periodic heartbeat comments on both SSE endpoints and ensure server cleans up on disconnect to prevent resource leaks.
- **Definition of Done**:
  1. Append timer-driven `:heartbeat` comments (e.g., every 15 seconds) while connections are open; cancel timers on `close`.
  2. Update integration script to tolerate/ignore heartbeat messages and confirm streams remain idle before start.
  3. Add regression coverage (unit or integration) asserting heartbeats are sent and do not interfere with frame parsing.

## Task 3: Authentication & Rate Limiting Baseline
- **Lifecycle**: Phase 6 Stabilization — Step 3 (Access Control)
- **Mindset**: Implementer
- **Workspace**: `workspaces/Describing_Simulation_0/src/routes/router.ts`, route registrations, tests.
- **Guardrails**:
  - `instruction_documents/Describing_Simulation_0_codifying_simulations.md` — Server structure.
  - Future deployment considerations (documented in `routes/information/api.md`).
- **Objective**: Introduce a pluggable auth middleware supporting static token authentication and per-endpoint request throttling to prevent abuse.
- **Definition of Done**:
  1. Add middleware hooks in `Router` to validate an `Authorization` header (configurable shared secret for now); unauthorized calls return `401`.
  2. Implement lightweight per-route rate limiting (e.g., token bucket per IP) suitable for local iteration but configurable for production.
  3. Extend tests to cover success/failure cases and document usage in `routes/information/api.md` plus `workspaces/Describing_Simulation_0/README.md`.
